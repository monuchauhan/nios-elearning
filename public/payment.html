<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment - NIOS D.El.Ed Prep</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="logo">
          <div class="logo-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
          </div>
          NIOS D.El.Ed Prep
        </a>
        
        <div class="nav-links">
          <a href="/" class="nav-link">Home</a>
          <a href="/course" class="nav-link">Course</a>
        </div>
        
        <div class="nav-user hidden" id="nav-user">
          <div class="user-avatar">U</div>
          <button onclick="logout()" class="btn btn-sm btn-ghost">Logout</button>
        </div>
        
        <div class="nav-auth" id="nav-auth">
          <a href="/login" class="btn btn-ghost">Login</a>
          <a href="/signup" class="btn btn-primary">Sign Up</a>
        </div>
      </nav>
    </div>
  </header>

  <!-- Payment Page -->
  <main class="payment-page">
    <div class="container">
      <div class="payment-grid">
        <!-- Payment Form -->
        <div class="payment-form-section">
          <h1>Complete Your Purchase</h1>
          <p style="color: var(--gray-600); margin-bottom: 2rem;">
            You're one step away from accessing the complete course!
          </p>
          
          <div id="login-required" class="alert alert-info hidden">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Please <a href="/login?redirect=/payment">login</a> or <a href="/signup">create an account</a> to continue.
          </div>

          <div id="already-purchased" class="alert alert-success hidden">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            You already have access to this course! <a href="/course">Go to Course</a>
          </div>
          
          <div id="payment-form-container">
            <div class="card">
              <div class="card-body">
                <h3 class="mb-4">Payment Details</h3>
                
                <!-- Razorpay Notice -->
                <div class="alert alert-info mb-4">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  <div>
                    <strong>Secure Payment:</strong> You will be redirected to Razorpay's secure checkout. Supports UPI, Cards, Net Banking, Wallets & EMI.
                  </div>
                </div>

                <!-- Razorpay Pay Button -->
                <button type="button" class="btn btn-primary btn-lg btn-block" id="pay-btn" onclick="initiatePayment()">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line>
                  </svg>
                  Pay ₹<span id="pay-amount">999</span> with Razorpay
                </button>
                
                <div class="text-center mt-4" style="color: var(--gray-500); font-size: 0.875rem;">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                  Your payment is secure and encrypted
                </div>
              </div>
            </div>
          </div>
          
          <!-- Success Message -->
          <div id="payment-success" class="card hidden">
            <div class="card-body text-center" style="padding: 3rem;">
              <div style="width: 80px; height: 80px; background: rgba(34, 197, 94, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              </div>
              <h2>Payment Successful!</h2>
              <p style="color: var(--gray-600); margin: 1rem 0 2rem;">
                Congratulations! You now have full access to all chapters, study materials, and quizzes.
              </p>
              <a href="/course" class="btn btn-primary btn-lg">Start Learning Now</a>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="order-summary-section">
          <div class="card">
            <div class="card-body">
              <h3 class="mb-4">Order Summary</h3>
              
              <div class="order-summary">
                <div class="order-item">
                  <span>NIOS D.El.Ed Complete Course</span>
                  <span id="original-price" style="text-decoration: line-through; color: var(--gray-400);">₹699</span>
                </div>
                <div class="order-item" id="discount-row">
                  <span style="color: var(--success);">45% Launch Discount</span>
                  <span style="color: var(--success);" id="discount-amount">-₹310</span>
                </div>
                <div class="order-item order-total">
                  <span>Total</span>
                  <span id="total-price">₹389</span>
                </div>
              </div>
              
              <!-- What's Included -->
              <div class="mt-5">
                <h4 style="margin-bottom: 1rem;">What's Included</h4>
                <ul style="color: var(--gray-600); font-size: 0.875rem;">
                  <li class="flex items-center gap-2 mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    3 complete courses (501, 502, 503)
                  </li>
                  <li class="flex items-center gap-2 mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Video lectures in Hindi & English
                  </li>
                  <li class="flex items-center gap-2 mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Audio podcasts for each block
                  </li>
                  <li class="flex items-center gap-2 mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    20+ downloadable PDF study materials
                  </li>
                  <li class="flex items-center gap-2 mb-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    200+ quiz questions with explanations
                  </li>
                  <li class="flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Lifetime access
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-bottom" style="border-top: none; padding-top: 0;">
        <p>&copy; 2026 NIOS D.El.Ed Prep. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script src="/js/auth.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let originalPrice = 699;
    let currentPrice = 389;
    let discount = 310;
    let appliedCoupon = 'LAUNCH45';

    // Check if user is logged in
    async function checkAuthAndPurchase() {
      if (!isLoggedIn()) {
        document.getElementById('login-required').classList.remove('hidden');
        document.getElementById('payment-form-container').classList.add('hidden');
        return;
      }
      
      // Check if already purchased
      try {
        const response = await authAPI.getMe();
        updateUser(response.user);
        
        if (response.user.hasPurchased) {
          document.getElementById('already-purchased').classList.remove('hidden');
          document.getElementById('payment-form-container').classList.add('hidden');
        }
      } catch (error) {
        console.error('Error checking purchase status:', error);
      }
    }

    // Update pay button amount
    function updatePayAmount() {
      document.getElementById('pay-amount').textContent = currentPrice;
    }

    // Apply coupon
    async function applyCoupon() {
      const code = document.getElementById('coupon-code').value.trim();
      const messageEl = document.getElementById('coupon-message');
      const applyBtn = document.getElementById('apply-coupon-btn');
      
      if (!code) {
        messageEl.innerHTML = '<span class="coupon-error">Please enter a coupon code</span>';
        return;
      }
      
      applyBtn.disabled = true;
      applyBtn.textContent = 'Applying...';
      
      try {
        const response = await paymentAPI.validateCoupon(code);
        
        appliedCoupon = code;
        discount = response.discount;
        currentPrice = response.finalPrice;
        
        // Update UI
        document.getElementById('discount-row').classList.remove('hidden');
        document.getElementById('discount-amount').textContent = `-₹${discount}`;
        document.getElementById('total-price').textContent = `₹${currentPrice}`;
        updatePayAmount();
        
        messageEl.innerHTML = `<span class="coupon-success">${response.message}</span>`;
        document.getElementById('coupon-code').disabled = true;
        applyBtn.disabled = true;
        applyBtn.textContent = 'Applied';
      } catch (error) {
        messageEl.innerHTML = `<span class="coupon-error">${error.message}</span>`;
        applyBtn.disabled = false;
        applyBtn.textContent = 'Apply';
      }
    }

    // Razorpay payment integration
    let razorpayKeyId = null;

    // Fetch Razorpay key on load
    async function fetchRazorpayConfig() {
      try {
        const response = await fetch('/api/payment/config', {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await response.json();
        razorpayKeyId = data.keyId;
      } catch (error) {
        console.error('Failed to fetch Razorpay config:', error);
      }
    }

    // Initiate Razorpay payment
    async function initiatePayment() {
      const payBtn = document.getElementById('pay-btn');
      
      if (!razorpayKeyId) {
        alert('Payment system not ready. Please refresh the page.');
        return;
      }

      payBtn.disabled = true;
      payBtn.innerHTML = `
        <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
        Creating Order...
      `;

      try {
        // Create order on server
        const orderResponse = await fetch('/api/payment/create-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({ couponCode: appliedCoupon })
        });

        if (!orderResponse.ok) {
          const error = await orderResponse.json();
          throw new Error(error.message || 'Failed to create order');
        }

        const orderData = await orderResponse.json();

        // Get user info for prefill
        const user = getUser();

        // Razorpay checkout options
        const options = {
          key: razorpayKeyId,
          amount: orderData.amount,
          currency: orderData.currency,
          name: 'NIOS D.El.Ed Prep',
          description: 'Complete Exam Prep Course',
          order_id: orderData.orderId,
          handler: async function(response) {
            // Payment successful, verify on server
            await verifyPayment(response);
          },
          prefill: {
            name: user?.name || '',
            email: user?.email || '',
            contact: user?.mobile || ''
          },
          theme: {
            color: '#4f46e5'
          },
          modal: {
            ondismiss: function() {
              resetPayButton();
            }
          }
        };

        // Open Razorpay checkout
        const razorpay = new Razorpay(options);
        razorpay.on('payment.failed', function(response) {
          alert('Payment failed: ' + response.error.description);
          resetPayButton();
        });
        razorpay.open();

      } catch (error) {
        alert('Error: ' + error.message);
        resetPayButton();
      }
    }

    // Verify payment on server
    async function verifyPayment(razorpayResponse) {
      const payBtn = document.getElementById('pay-btn');
      payBtn.innerHTML = `
        <div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>
        Verifying Payment...
      `;

      try {
        const response = await fetch('/api/payment/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({
            razorpay_order_id: razorpayResponse.razorpay_order_id,
            razorpay_payment_id: razorpayResponse.razorpay_payment_id,
            razorpay_signature: razorpayResponse.razorpay_signature
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Payment verification failed');
        }

        // Update user data
        const userResponse = await authAPI.getMe();
        updateUser(userResponse.user);

        // Show success
        document.getElementById('payment-form-container').classList.add('hidden');
        document.getElementById('payment-success').classList.remove('hidden');

      } catch (error) {
        alert('Payment verification failed: ' + error.message);
        resetPayButton();
      }
    }

    // Reset pay button
    function resetPayButton() {
      const payBtn = document.getElementById('pay-btn');
      payBtn.disabled = false;
      payBtn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
          <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
        Pay ₹<span id="pay-amount">${currentPrice}</span> with Razorpay
      `;
    }

    // Initialize
    checkAuthAndPurchase();
    fetchRazorpayConfig();
  </script>
</body>
</html>
